---
layout: post
title: "用演进式架构支撑业务发展"
date: 2020-05-24
---

4 月初，小田刚刚成为一个新项目的技术负责人。这个项目是公司内部的一个创新型项目，旨在使用某种新型技术为公司的客户提供更好的产品体验。项目的产品负责人期望在 5 月初向公司领导汇报项目进度，验证产品可行性，并争取产品的推广机会。小田和他的团队需要在 4 月份完成对新技术的攻关，并实现一个基本的产品流程，以帮助领导建立信心。

在项目启动会议上，小田敏锐地识别到项目有大量的搜索需求。在和产品负责人确定产品未来的数据量将会超过千万级后，小田果断地决定采用 Elastic Search 作为搜索引擎，以应对未来的数据量增长。为此，小田和另一位资深开发人员花费了大约 2 周的时间搭建了 Elastic Search 集群，并且在 MySQL 和 Elastic Search 之间设计了数据同步机制，即便未来数据量比较大，MySQL 中产生的数据也能低延迟地同步至 Elastic Search，供用户使用。

然而，这同时也导致本就很困难的新技术攻关更加捉襟见肘。在小田和团队的不懈努力并牺牲了五一假期之后，团队虽然打通了所有的技术要点，却没有给测试和产品人员留出足够的时间。汇报如期到来，并不成功，系统在几个关键流程处报错，领导们在一番讨论后认为这项新技术还不成熟，决定暂时将项目搁置。

> 技术人员常常希望在项目一开始就设计出“完美”的架构，这也意味着巨大的投入，当我们在追求“完美”时，常常已经错失了最好的机会。

汇报会结束后，一个神秘的老人出现在沮丧的小田面前：“小伙子，后悔吗？我这有一个月光宝盒，你要不要试试？”小田将信将疑地打开了宝盒……

时间竟然神奇地回到了 4 月初，这一次小田决定不再重蹈覆辙，直接在 MySQL 中使用 like 语句进行搜索，将 Elastic Search 列为未来的技术改进事项，整个 4 月都交给了新技术的攻关。

5 月初的汇报会进行得很顺利，领导当场决定在 7 月底的行业峰会上向业界发布产品。接下来 2 个月小田和他的团队开始紧锣密鼓地完善整个产品流程。到了 7 月中旬，团队已经完成了业务功能的开发，小田一边支持着团队进行最后的回归测试，一边开始推动团队进行 Elastic Search 改造。

7 月底的发布会也进行得很顺利，产品在业界取得了巨大的反响，8 月初已经开始有大量客户入驻。另一方面，Elastic Search 改造进行得却不太顺利。由于搜索功能的代码和其他业务代码耦合得很严重，改造工作进行得十分缓慢，每一次代码的调整都必须非常小心，以免造成一些意外的 bug。到了 8 月底，已经开始有用户上报搜索没有响应，小田一边支持着线上问题，对已有的 MySQL 搜索进行优化，一边艰难地继续推进 Elastic Search 改造。

终于，Elastic Search 在 9 月底的版本中上线。然而，产品在 8 月和 9 月已经流失了大量用户，错失了一个黄金增长期……

> 以后再做就等于再也不做，这样的事情在项目上再常见不过。进度的压力常常逼着我们将重要的事情一拖再拖，蓦然回首，发现技术债已然堆积如山。

愤怒的小田再一次启动了月光宝盒，时间再次回溯到 4 月初……

这一次小田采用了六边形架构端口和适配器的理念，对领域层和仓储层进行了隔离，并通过架构测试提供约束，防止仓储层逻辑入侵到领域层；进一步地，小田使用了分离接口的方法，将搜索接口与其他仓储接口隔离开来，在前期使用 MySQL 适配器同时实现两个接口，未来使用 Elastic Search 适配器实现搜索接口即可实现切换。在投入了两天撰写完整的示例代码并向团队做出详细讲解后，小田再一次投入到新技术攻关的工作中。

时间再一次经过 5 月和 7 月的节点，这一次 Elastic Search 的改造进行得很顺利，在 8 月底就上线了 Elastic Search。9 月份产品迎来了爆发式的增长。

> 在数字技术极大发展的今天，即便是很小的项目，也常常需要使用各种不同的技术实现不同的业务目标，我们很难在一开始就将所有技术引入到项目中，Elastic Search 只是其中一例。但是，对系统的关注点进行隔离只需要在一开始投入很小的成本，却为架构的演进留下了无限的可能。六边形架构如是，微服务亦如是。

以上故事，纯属虚构；如有雷同，实属正常。
