---
layout: post
title: "遗留系统改造"
date: 2020-03-15
---

## 0. 背景

过去 20 年，大量的传统企业已经完成了信息化建设。然而，随着数字化时代的到来，很多曾经的解决方案却摇身一变成为遗留系统，是企业进一步创新和响应市场变化的重要阻力之一。遗留系统承载了企业的大量核心业务。然而由于年久失修，已经没有人说得清为什么有这些业务，代码模块之间的关系也已经模糊，给程序员理解代码和业务带来了极大挑战。因此，遗留系统改造逐渐成为了各大企业的技术重点和难点之一。

改造遗留系统的挑战来自三个方面：

1. 如何有效地分析系统。由于遗留系统过于庞大，内部关系又错综复杂，常常让架构师和程序员觉得无从下手，还没有开始就已经认输了；
2. 如何安全地改造系统。核心代码牵一发而动全身，如何保证改造的过程中已有功能不被破坏成为大家头痛的难题，更不用说如何在改造遗留系统的同时保证新需求如期上线了；
3. 如何固化改造成果。改造的速度常常赶不上架构腐化的速度，这边的代码刚刚整理出了眉目，那边的技术债却越积越多。

![](/assets/20200315/1.png)

## 1. 系统分析

> 认识世界是为了改造世界，正确地认识世界是有效地改造世界的必要前提。然而，人们只有在改造世界的实践中才能正确地认识世界，二者统一的基础是实践。
>
> ——《马克思主义哲学》

### 1.1. 业务知识的梳理

系统分析的第一个关键点是业务知识的梳理。业务知识是团队对系统进行分解的基础，它的缺失会则会导致改造失去方向。除了阅读文档和询问相关人员以外，团队可以使用“事件风暴”的方法来走查场景，建立统一的领域模型，使之成为团队日常工作的基础。在改造过程中，随着对领域模型的进一步理解，团队也必须随时调整模型，以反映真实的情况。这是一个艰苦而漫长的过程，需要团队展现足够的技巧和耐心。

### 1.2. 可视化的依赖关系

系统分析的第二个关键点是对代码和数据库依赖关系的分析。系统改造的本质是对依赖关系的整理，消除不恰当的依赖关系，重建符合业务逻辑的依赖关系是系统改造过程中的最主要工作。在这个过程中，需要大量地使用可视化依赖分析工具，使团队成员对系统情况做到心中有数，循序渐进地改造系统，以免出现改到一半发现“改不动”的糟糕情况。

### 1.3. 原则：价值导向的架构决策

系统分析的目的不仅仅是理解当下的业务和架构状态，更重要的是为接下来的改造指明方向。系统改造应该从价值出发，对市场响应力、质量、可用性、开放性等几个方面进行架构评估，将理想与现实之间的差距量化，聚焦价值最大的方向，使架构决策更客观，投资更精准。

## 2. 改造系统

改造遗留系统是一项复杂的工作。受篇幅所限，我没有办法穷举我们已经做过的全部工作，这里仅仅将部分关键点罗列如下。

### 2.1. 测试守护

想要安全地改造遗留系统，测试是必不可少的一环。没有测试守护的系统改造就像是不戴口罩面对新冠病毒，不知道什么时候就被感染了。然而，遗留系统常常缺少足够的测试覆盖，补全测试显然不现实。我们的团队在实践中开发了一套 A/B 测试工具，录制改造前的测试人员全流程操作，并对改造后的系统进行回放，安全地代码修改应该保证两次操作产生的数据库结果完全一致。

![](/assets/20200315/2.png)

### 2.2. 改造 PLSQL

较早的 IT 系统主要采用以数据库为中心的系统构建方法。这导致遗留系统中存在着大量以 PLSQL 和存储过程为形式的业务代码。这些代码十分难以理解，我们的团队在实践中发现普通开发人员大约一天可以改造 15 行左右的 PLSQL 代码，这是我们在遗留系统改造过程中遇到的最难啃的骨头。为了解决这个难题，团队构建了一套将 PLSQL 转化为 Kotlin 代码的工具，在此工具的帮助下，开发人员一天可以改造大约 500 行 PLSQL 代码，带来了 30 倍效率的提升。

### 2.3. 各项实践的基准化

在遗留系统改造的过程中，另外一项重要的实践是不断对操作手法进行基准化。Martin Fowler 在《重构》一书中总结了 20 多种代码坏味道以及数十种基准操作手法，这帮助开发人员减少了代码修改当中的风险，提高了系统改造的效率。除了这些基准操作以外，我们在遗留系统改造的过程中也沉淀了多项基准化实践。其中，对模块拆分手法和数据库拆分手法的基准化使每个人都受益匪浅。

## 3. 守护系统

![](/assets/20200315/3.png)

系统通常会掉入`构建->演进->腐化->重建`的循环陷阱当中。想要避免这一循环，需要团队从基准化入手，降低门槛，减少出错；在系统演进过程中依托可视化和度量工具及时预警，持续重构，及时纠偏；而在系统重构和演进的过程中又会形成新的基准化操作。这一闭环的不断加强将使得系统架构越来越健壮。

## 4. 写在最后

对遗留系统进行改造是一项长期工作，这项工作依赖团队中的每一个成员去发动他们的知识与智慧，展现足够的耐心和强大的执行力，帮助每一个遗留系统成为企业数字化转型当中的助力。

![](/assets/20200315/4.png)
